//------------Sonic CD Tube Switch Script-------------//
//--------Scripted by Christian Whitehead 'The Taxman'--------//
//-------Unpacked By Rubberduckycooly's Script Unpacker-------//

// Aliases
#alias 42: TYPE_TUBESWITCH

#alias Object.Value0 : Object.InTube

#alias 0 : TUBESWITCH_GROUND
#alias 0 : TUBESWITCH_GROUND

#alias Player.Value6 : Player.MinRollSpeed


sub ObjectPlayerInteraction
	PlayerObjectCollision(C_TOUCH, -16, -16, 16, 16)
	if CheckResult == true
		switch Object.PropertyValue
		case 0
			if Object.InTube == false
				if Player.State != PlayerObject_StartTTCtrlLock
					Player.State = PlayerObject_StartTTCtrlLock
					Player.Gravity = 0
					Player.Animation = ANI_JUMPING
					Player.MinRollSpeed = 851968
				else
					Player.State = PlayerObject_HandleRolling
					Player.Animation = ANI_JUMPING
				end if
			end if
			break

		case 1
			Player.State = PlayerObject_HandleAir
			Player.Animation = ANI_JUMPING
			if Player.Gravity == 1
				if Player.YVelocity < 0
					Player.YVelocity = -851968
				else
					Player.YVelocity = 851968
				end if
			else
				switch Player.CollisionMode
				case 1
					if Player.Speed < 0
						Player.YVelocity = 851968
					else
						Player.YVelocity = -851968
					end if
					break
				case 3
					if Player.Speed < 0
						Player.YVelocity = -851968
					else
						Player.YVelocity = 851968
					end if
					break
				end switch
			end if
			Player.Gravity = 1
			Player.XPos = Object.XPos
			Player.XVelocity = 0
			Player.Speed = 0
			break

		case 2
			if Object.InTube == false
				if Player.State != PlayerObject_StartTTCtrlLock
					Player.XPos = Object.XPos
					Player.State = PlayerObject_StartTTCtrlLock
					Player.Animation = ANI_JUMPING
					Player.MinRollSpeed = 851968
					Player.CollisionMode = 3
					Player.Angle = 64
					Player.Gravity = 0
					Player.XVelocity = 0
					if Player.YVelocity < 0
						Player.Speed = -851968
					else
						Player.Speed = 851968
					end if
					Player.YVelocity = 0
					Player.Right = 0
					Player.Left = 0
				else
					Player.State = PlayerObject_HandleAir
					Player.Animation = ANI_JUMPING
					switch Player.CollisionMode
					case 1
						if Player.Speed < 0
							Player.YVelocity = 851968
						else
							Player.YVelocity = -851968
						end if
						break
					case 3
						if Player.Speed < 0
							Player.YVelocity = -851968
						else
							Player.YVelocity = 851968
						end if
						break
					end switch
					Player.Gravity = 1
					Player.XPos = Object.XPos
					Player.XVelocity = 0
					Player.Speed = 0
				end if
			end if
			break

		case 3
			if Object.InTube == false
				if Player.CollisionMode == 2
					Player.CollisionMode = 0
					Player.Angle = 0
					FlipSign(Player.Speed)
					FlipSign(Player.XVelocity)
				end if
			end if
			break

		case 4
			if Object.InTube == false
				Player.State = PlayerObject_HandleRolling
				Player.Animation = ANI_JUMPING
				if Player.XPos < Object.XPos
					if Player.Speed < 655360
						Player.Speed = 655360
					end if
					Player.Direction = FACING_RIGHT
				else
					if Player.Speed > -655360
						Player.Speed = -655360
					end if
					Player.Direction = FACING_LEFT
				end if
			end if
			break

		case 5
			if Player.YVelocity < 0
				if Player.State != PlayerObject_StartTTCtrlLock
					if Player.Left == true
						Player.State = PlayerObject_StartTTCtrlLock
						Player.Gravity = 0
						Player.CollisionMode = 3
						Player.Angle = 64
						Player.Animation = ANI_JUMPING
						Player.MinRollSpeed = 851968
						Player.Speed = -851968
						Player.XVelocity = 0
						Player.YVelocity = 0
						Player.XPos -= 524288
					end if
					if Player.Right == true
						Player.State = PlayerObject_StartTTCtrlLock
						Player.Gravity = 0
						Player.CollisionMode = 1
						Player.Angle = 192
						Player.Animation = ANI_JUMPING
						Player.MinRollSpeed = 851968
						Player.Speed = 851968
						Player.XVelocity = 0
						Player.YVelocity = 0
						Player.XPos += 524288
					end if
				end if
			end if
			break

		case 6
			if Object.InTube == 0
				if Player.State == PlayerObject_HandleAir
					Player.XPos = Object.XPos
					Player.XVelocity = 0
					Player.Speed = 0
				end if
			end if
			break

		case 7
			if Object.InTube == false
				if Player.CollisionMode == 2
					Player.CollisionMode = 0
					Player.Angle += 128
					FlipSign(Player.Speed)
					FlipSign(Player.XVelocity)
				end if
			end if
			break

		end switch

		Object.InTube = true
	else
		Object.InTube = false
	end if
end sub

// ========================
// Editor Subs
// ========================

sub RSDKDraw
	// This object doesn't have a debug view, so this is custom
	// It draws a square out of tubeswitch icons

	TempValue0 = Object.XPos
	TempValue0 -= 0x80000
	TempValue1 = Object.YPos
	TempValue1 -= 0x80000
	DrawSpriteXY(0, TempValue0, TempValue1)
	TempValue0 += 0x100000
	DrawSpriteXY(0, TempValue0, TempValue1)
	TempValue1 += 0x100000
	DrawSpriteXY(0, TempValue0, TempValue1)
	TempValue0 -= 0x100000
	DrawSpriteXY(0, TempValue0, TempValue1)
	
	if Editor.ShowGizmos == true
		// Draw the tube switch's hitbox, purposefully ignoring Editor.DrawingOverlay
		
		TempValue0 = Object.XPos
		TempValue0 -= 0x80000
		TempValue1 = Object.YPos
		TempValue1 -= 0x80000
		DrawRectOutline(TempValue0, TempValue1, 0x100000, 0x100000, 255, 255, 255, 255)
	end if
end sub


sub RSDKLoad
	LoadSpriteSheet("Global/Display.gif")
	SpriteFrame(-8, -8, 16, 16, 173, 67) // "T" (ubeswitch) icon

	SetVariableAlias(ALIAS_VAR_PROPVAL, "unused")
end sub
