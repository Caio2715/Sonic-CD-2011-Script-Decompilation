//------------Sonic CD R6 Setup Script-------------//
//--------Scripted by Christian Whitehead 'The Taxman'--------//
//-------Unpacked By Rubberduckycooly's Script Unpacker-------//

// Aliases
#alias Object.Value1	:	Object.PaletteBank
#alias Object.Value4	:	Object.LightTile
#alias Object.Value5	:	Object.ElectricTile
#alias Object.Value6	:	Object.BounceFloorAnim
#alias Object.Value7	:	Object.BounceFloorTile
#alias Object.Scale		:	Object.BounceFloorFlag

// Player Aliases
#alias Player.Value4	:	Player.Invincible

// Gravity
#alias 1				:	GRAVITY_AIR

// Priority
#alias 1				:	PRIORITY_ACTIVE


sub ObjectMain
	TempValue0 = Object.LightTile
	TempValue0 &= 1
	if TempValue0 == 0
		TempValue0 = Object.LightTile
		TempValue0 >>= 1
		TempValue0 += 808
		Copy16x16Tile(579, TempValue0)
	end if
	Object.LightTile++
	Object.LightTile %= 24

	TempValue0 = Object.ElectricTile
	TempValue0 %= 5
	if TempValue0 == 0
		TempValue0 = Object.ElectricTile
		TempValue0 /= 5
		TempValue0 += 820
		Copy16x16Tile(580, TempValue0)
		TempValue0 += 3
		Copy16x16Tile(581, TempValue0)
	end if
	Object.ElectricTile++
	Object.ElectricTile %= 15
	
	TempValue0 = Object.BounceFloorAnim
	TempValue0 &= 1
	if TempValue0 == 0
		TempValue0 = Object.BounceFloorTile
		TempValue0 += 826
		Object.BounceFloorTile++
		Object.BounceFloorTile %= 6
		Copy16x16Tile(543, TempValue0)
	end if
	Object.BounceFloorAnim++
	Object.BounceFloorAnim &= 511

	Object.BounceFloorFlag = true

	TempValue0 = Object.PaletteBank
	TempValue0 >>= 1
	SetActivePalette(TempValue0, 0, Screen.YSize)
	Object.PaletteBank++
	Object.PaletteBank %= 6
end sub


sub ObjectPlayerInteraction
	TempValue2 = Player.XPos
	TempValue2 >>= 16
	TempValue2 += Player.CollisionRight

	TempValue3 = Player.YPos
	TempValue3 >>= 16
	TempValue3 += Player.CollisionBottom
	TempValue3 += 2
	Get16x16TileInfo(TempValue0, TempValue2, TempValue3, 8)

	TempValue2 = Player.XPos
	TempValue2 >>= 16
	TempValue2 += Player.CollisionLeft
	Get16x16TileInfo(TempValue1, TempValue2, TempValue3, 8)

	TempValue0 |= TempValue1
	if TempValue0 == 1
		if Object.BounceFloorFlag == true
			if Player.YVelocity > -1
				Player.Animation = ANI_JUMPING
				Player.Gravity = GRAVITY_AIR
				Player.Timer = 0
				Player.YVelocity = -1441792

#platform: Use_Origins
				Player.State = PlayerObject_ResetDropDash
#endplatform

#platform: Use_Standalone
				Player.State = PlayerObject_HandleAir
#endplatform
				PlayStageSfx(0, 0)
			end if
		end if
	end if

	TempValue2 -= Player.CollisionLeft
	TempValue3 -= Player.CollisionBottom
	TempValue3 -= 2
	Get16x16TileInfo(TempValue0, TempValue2, TempValue3, 8)
	switch TempValue0
	case 2
		if Player.Invincible == 0
			Player.State = PlayerObject_Hurt
			if Player.Direction == FACING_LEFT
				Player.Speed = 0x20000
			else
				Player.Speed = -0x20000
			end if
		end if
		break
	case 5
		if Object.State == 2
			if Player.Invincible == 0
				Player.State = PlayerObject_Hurt
				if Player.Direction == FACING_LEFT
					Player.Speed = 0x20000
				else
					Player.Speed = -0x20000
				end if
			end if
		end if
		break
	case 6
		if Object.State == 2
			if Object.Direction == FACING_RIGHT
				if Player.Invincible == 0
					Player.State = PlayerObject_Hurt
					if Player.Direction == FACING_LEFT
						Player.Speed = 0x20000
					else
						Player.Speed = -0x20000
					end if
				end if
			end if
		end if
		break
	case 7
		if Object.State == 2
			if Object.Direction == FACING_LEFT
				if Player.Invincible == 0
					Player.State = PlayerObject_Hurt
					if Player.Direction == FACING_LEFT
						Player.Speed = 0x20000
					else
						Player.Speed = -0x20000
					end if
				end if
			end if
		end if
		break
	case 8
		if Object.State == 2
			if Object.Direction == 2
				if Player.Invincible == 0
					Player.State = PlayerObject_Hurt
					if Player.Direction == FACING_LEFT
						Player.Speed = 0x20000
					else
						Player.Speed = -0x20000
					end if
				end if
			end if
		end if
		break
	end switch
	TempValue3 -= 4
	Get16x16TileInfo(TempValue0, TempValue2, TempValue3, 8)
	switch TempValue0
	case 2
		if Player.Invincible == 0
			Player.State = PlayerObject_Hurt
			if Player.Direction == FACING_LEFT
				Player.Speed = 0x20000
			else
				Player.Speed = -0x20000
			end if
		end if
		break
	case 5
		if Object.State == 2
			if Player.Invincible == 0
				Player.State = PlayerObject_Hurt
				if Player.Direction == FACING_LEFT
					Player.Speed = 0x20000
				else
					Player.Speed = -0x20000
				end if
			end if
		end if
		break
	case 6
		if Object.State == 2
			if Object.Direction == FACING_RIGHT
				if Player.Invincible == 0
					Player.State = PlayerObject_Hurt
					if Player.Direction == FACING_LEFT
						Player.Speed = 0x20000
					else
						Player.Speed = -0x20000
					end if
				end if
			end if
		end if
		break
	case 7
		if Object.State == 2
			if Object.Direction == FACING_LEFT
				if Player.Invincible == 0
					Player.State = PlayerObject_Hurt
					if Player.Direction == FACING_LEFT
						Player.Speed = 0x20000
					else
						Player.Speed = -0x20000
					end if
				end if
			end if
		end if
		break
	case 8
		if Object.State == 2
			if Object.Direction == 2
				if Player.Invincible == 0
					Player.State = PlayerObject_Hurt
					if Player.Direction == FACING_LEFT
						Player.Speed = 0x20000
					else
						Player.Speed = -0x20000
					end if
				end if
			end if
		end if
		break
	end switch
	TempValue3 += 4
	TempValue3 += Player.CollisionTop
	Get16x16TileInfo(TempValue0, TempValue2, TempValue3, 8)
	if TempValue0 == 3
		TempValue4 = TempValue3
		TempValue4 &= 15
		if TempValue4 < 8
			if Player.State != PlayerObject_HangingBar
				Player.State = PlayerObject_HangingBar
				Player.YVelocity = 0
				Player.Animation = ANI_HANGING
				TempValue3 &= 32752
				TempValue3 += 4
				TempValue3 -= Player.CollisionTop
				Player.iYPos = TempValue3
				PlayStageSfx(2, 0)
				Screen.AdjustCameraY = 0
			end if
		end if
	end if
end sub


sub ObjectStartup
	Object[19].Type = TypeName[R6Setup]
	Object[19].Priority = PRIORITY_ACTIVE
	Object[19].DrawOrder = 2
	
	TempValue0 = 1
	while TempValue0 < 3
		RotatePalette(161, 163, 0)
		CopyPalette(0, TempValue0)
		TempValue0++
	loop
	RotatePalette(161, 163, 0)
end sub

// ========================
// Editor Subs
// ========================

sub RSDKDraw
	DrawSprite(0)
end sub

sub RSDKLoad
	LoadSpriteSheet("Global/Display.gif")
	SpriteFrame(-16, -16, 32, 32, 1, 143)		// #0 - "Script" Icon

	SetVariableAlias(ALIAS_VAR_PROPVAL, "unused")
end sub
