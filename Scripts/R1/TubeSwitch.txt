//-----------------Sonic CD Tube Switch Script----------------//
//--------Scripted by Christian Whitehead 'The Taxman'--------//
//-------Unpacked By Rubberduckycooly's Script Unpacker-------//

// Aliases
#alias Object.Value0	:	Object.OnObject

// Player Aliases
#alias Player.Value6	:	Player.MinRollSpeed

// Gravity
#alias 0	:	GRAVITY_GROUND
#alias 1	:	GRAVITY_AIR

// Collision Modes
#alias 0	:	CMODE_FLOOR
#alias 1	:	CMODE_LWALL
#alias 2	:	CMODE_ROOF
#alias 3	:	CMODE_RWALL

// Property Values
#alias 0	:	TUBESWITCH_ENTER_H
#alias 1	:	TUBESWITCH_ENTER_V
#alias 2	:	TUBESWITCH_BOOST_ANGLE
#alias 3	:	TUBESWITCH_BOOST_V
#alias 4	:	TUBESWITCH_EXIT_H
#alias 5	:	TUBESWITCH_EXIT_V
#alias 6	:	TUBESWITCH_LIMIT_SPEED
#alias 7	:	TUBESWITCH_EXIT_ANGLE
#alias 8	:	TUBESWITCH_EXIT_BOOST


sub ObjectPlayerInteraction
	PlayerObjectCollision(C_TOUCH, -16, -16, 16, 16)
	if CheckResult == true
		switch Object.PropertyValue
		case TUBESWITCH_ENTER_H
			if Player.Speed > 0
				if Player.State != PlayerObject_Tunnel
					PlaySfx(7, 0)
				end if

				Player.Direction = FACING_RIGHT
				Player.State = PlayerObject_Tunnel
				Player.Animation = ANI_JUMPING
				Player.MinRollSpeed = 0xA0000	// 0xA0000

				if Player.Speed < 0xA0000		// 0xA0000
					Player.Speed = 0xA0000		// 0xA0000
				end if
			else
				if Player.Gravity == GRAVITY_GROUND

					if Player.Speed > -0x20000	// -0x20000
						Player.Speed = -0x20000	// -0x20000
					end if

				end if
				Player.State = PlayerObject_HandleRolling
				Player.Animation = ANI_JUMPING
			end if
			break

		case TUBESWITCH_ENTER_V
			if Player.State != PlayerObject_Tunnel
				PlaySfx(7, 0)
			end if
			Player.Gravity = GRAVITY_GROUND
			Player.State = PlayerObject_Tunnel
			Player.Animation = ANI_JUMPING
			Player.CollisionMode = CMODE_RWALL
			Player.Angle = 64
			Player.Speed = 0x100000			// 0x100000
			Player.MinRollSpeed = 0x100000	// 0x100000
			break

		case TUBESWITCH_BOOST_ANGLE
			if Object.OnObject == false
			
				if Player.CollisionMode == CMODE_FLOOR
					Player.CollisionMode = CMODE_ROOF
					FlipSign(Player.Speed)
					Player.Angle = 128
				else
					Player.CollisionMode = CMODE_FLOOR
					FlipSign(Player.Speed)
					Player.Angle = 0
					Player.YPos += 0x40000	// 0x40000
				end if

				Player.State = PlayerObject_Tunnel
				Player.Animation = ANI_JUMPING

			end if
			break

		case TUBESWITCH_BOOST_V
			if Player.YVelocity < 0

				Player.Gravity = GRAVITY_GROUND
				Player.State = PlayerObject_Tunnel
				Player.Animation = ANI_JUMPING
				Player.CollisionMode = CMODE_LWALL
				Player.Angle = 192
				Player.MinRollSpeed = 0xA0000	// 0xA0000
				Player.Speed = Player.YVelocity
				FlipSign(Player.Speed)

			end if
			break

		case TUBESWITCH_EXIT_H
			if Player.Speed < 0
				if Player.State != PlayerObject_Tunnel
					PlaySfx(7, 0)
				end if

				Player.State = PlayerObject_Tunnel
				Player.Animation = ANI_JUMPING
				Player.MinRollSpeed = 0xA0000	// 0xA0000
			else
				Player.State = PlayerObject_HandleRolling
				Player.Animation = ANI_JUMPING
			end if
			break

		case TUBESWITCH_EXIT_V
			if Player.Gravity == GRAVITY_AIR
				Player.XVelocity = Object.Value1
				Player.Speed = Object.Value1
			else
				if Player.CollisionMode == CMODE_LWALL
					Player.Angle = 196
					Cos256(TempValue0, Player.Angle)
					TempValue0 *= Player.Speed
					TempValue0 >>= 8
					if TempValue0 != 0
						Object.Value1 = TempValue0
					end if
				end if
			end if
			break

		case TUBESWITCH_LIMIT_SPEED
			if Player.State == PlayerObject_Tunnel

				if Player.YVelocity < -0x60000	// -0x60000
					Player.YVelocity = -0x60000	// -0x60000
				end if

			else
				Player.Animation = ANI_JUMPING
			end if
			break

		case TUBESWITCH_EXIT_ANGLE
			if Player.State == PlayerObject_Tunnel
				Object.PropertyValue = TUBESWITCH_EXIT_BOOST
			end if
			break

		case TUBESWITCH_EXIT_BOOST
			if Player.Gravity == GRAVITY_AIR
				Player.YVelocity = -0xA8000	// -0xA8000
				Object.PropertyValue = TUBESWITCH_EXIT_ANGLE
			end if
			break

		end switch
		
		Object.OnObject = true
	else
		Object.OnObject = false
	end if
end sub

// ========================
// Editor Subs
// ========================

sub RSDKDraw
	TempValue0 = Object.XPos
	TempValue0 -= 0x80000
	TempValue1 = Object.YPos
	TempValue1 -= 0x80000

	DrawSpriteXY(0, TempValue0, TempValue1)

	TempValue0 += 0x100000
	DrawSpriteXY(0, TempValue0, TempValue1)

	TempValue1 += 0x100000
	DrawSpriteXY(0, TempValue0, TempValue1)

	TempValue0 -= 0x100000
	DrawSpriteXY(0, TempValue0, TempValue1)
end sub

sub RSDKLoad
	LoadSpriteSheet("Global/Display.gif")
	SpriteFrame(-8, -8, 16, 16, 173, 67)		// #0 - "T" Icon

	SetVariableAlias(ALIAS_VAR_PROPVAL, "unused")
end sub
